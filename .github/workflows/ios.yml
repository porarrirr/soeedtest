name: iOS Build (No Codesign)

on:
  workflow_dispatch:
  push:
    branches:
      - main
      - master

permissions:
  contents: write

jobs:
  build-ios:
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: stable

      - name: Install dependencies
        run: flutter pub get

      - name: Install CocoaPods
        run: |
          cd ios
          pod install

      - name: Build iOS IPA without code signing
        env:
          SPEEDTEST_NPERF_ANDROID_CONFIG: ${{ secrets.SPEEDTEST_NPERF_ANDROID_CONFIG }}
          SPEEDTEST_NPERF_IOS_CONFIG: ${{ secrets.SPEEDTEST_NPERF_IOS_CONFIG }}
          SPEEDTEST_NPERF_WEB_URL: ${{ secrets.SPEEDTEST_NPERF_WEB_URL }}
          SPEEDTEST_OPEN_SPEED_TEST_URL: ${{ secrets.SPEEDTEST_OPEN_SPEED_TEST_URL }}
          SPEEDTEST_CLOUDFLARE_URL: ${{ secrets.SPEEDTEST_CLOUDFLARE_URL }}
        run: |
          : "${SPEEDTEST_NPERF_ANDROID_CONFIG:?Missing SPEEDTEST_NPERF_ANDROID_CONFIG}"
          : "${SPEEDTEST_NPERF_IOS_CONFIG:?Missing SPEEDTEST_NPERF_IOS_CONFIG}"
          : "${SPEEDTEST_NPERF_WEB_URL:?Missing SPEEDTEST_NPERF_WEB_URL}"
          : "${SPEEDTEST_OPEN_SPEED_TEST_URL:?Missing SPEEDTEST_OPEN_SPEED_TEST_URL}"
          flutter build ipa --release --no-codesign \
            --dart-define=SPEEDTEST_NPERF_ANDROID_CONFIG="${SPEEDTEST_NPERF_ANDROID_CONFIG}" \
            --dart-define=SPEEDTEST_NPERF_IOS_CONFIG="${SPEEDTEST_NPERF_IOS_CONFIG}" \
            --dart-define=SPEEDTEST_NPERF_WEB_URL="${SPEEDTEST_NPERF_WEB_URL}" \
            --dart-define=SPEEDTEST_OPEN_SPEED_TEST_URL="${SPEEDTEST_OPEN_SPEED_TEST_URL}" \
            --dart-define=SPEEDTEST_CLOUDFLARE_URL="${SPEEDTEST_CLOUDFLARE_URL}"

      - name: Prepare release assets
        run: |
          mkdir -p build/release-assets
          ipa_created=false

          if ls build/ios/ipa/*.ipa >/dev/null 2>&1; then
            for ipa in build/ios/ipa/*.ipa; do
              cp "$ipa" "build/release-assets/ios-$(basename "${ipa%.ipa}")-${{ github.run_id }}.ipa"
            done
            ipa_created=true
          fi

          if ls build/ios/archive/*.xcarchive >/dev/null 2>&1; then
            for archive in build/ios/archive/*.xcarchive; do
              ditto -c -k --sequesterRsrc --keepParent "$archive" "build/release-assets/ios-$(basename "$archive")-${{ github.run_id }}.zip"

              if [ "$ipa_created" = false ] && [ -d "$archive/Products/Applications/Runner.app" ]; then
                rm -rf build/release-ipa-temp
                mkdir -p build/release-ipa-temp/Payload
                cp -R "$archive/Products/Applications/Runner.app" build/release-ipa-temp/Payload/
                (
                  cd build/release-ipa-temp
                  zip -qry "../release-assets/ios-unsigned-runner-${{ github.run_id }}.ipa" Payload
                )
                ipa_created=true
              fi
            done
          fi

          if [ "$ipa_created" = false ] && [ -d build/ios/iphoneos/Runner.app ]; then
            rm -rf build/release-ipa-temp
            mkdir -p build/release-ipa-temp/Payload
            cp -R build/ios/iphoneos/Runner.app build/release-ipa-temp/Payload/
            (
              cd build/release-ipa-temp
              zip -qry "../release-assets/ios-unsigned-runner-${{ github.run_id }}.ipa" Payload
            )
            ipa_created=true
          fi

          if [ -d build/ios/iphoneos/Runner.app ]; then
            ditto -c -k --sequesterRsrc --keepParent build/ios/iphoneos/Runner.app "build/release-assets/ios-Runner.app-${{ github.run_id }}.zip"
          fi

      - name: Upload iOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ios-unsigned-artifacts
          if-no-files-found: warn
          path: |
            build/ios/ipa/*.ipa
            build/ios/archive/*.xcarchive
            build/ios/iphoneos/Runner.app

      - name: Compute release name
        id: release_meta
        shell: bash
        run: |
          release_name="$(TZ=Asia/Tokyo git show -s --date=format-local:'%Y-%m-%d %H:%M %Z' --format=%cd "$GITHUB_SHA")"
          echo "release_name=$release_name" >> "$GITHUB_OUTPUT"

      - name: Publish iOS artifacts to GitHub Release
        uses: ncipollo/release-action@v1
        with:
          tag: build-${{ github.sha }}
          name: ${{ steps.release_meta.outputs.release_name }}
          body: Automated build artifacts for commit ${{ github.sha }}
          prerelease: true
          allowUpdates: true
          artifacts: build/release-assets/*
